{% extends "_layout.html" %}

{% block title %}Dashboard - Domain Manager{% endblock %}

{% block content %}
    <div id="loading-overlay">
        <div>
            <p>Creating Certificate...</p>
            <small>This may take up to 90 seconds. The page will refresh when complete.</small>
        </div>
    </div>

    <!-- NEW: Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <h1>Domain Manager</h1>
        </div>
        <div class="top-bar-right">
            <div class="scheduler-status">
                Next IP Check: <strong>{{ next_ddns_run }}</strong><br>
                Next SSL Check: <strong>{{ next_ssl_run }}</strong>
            </div>
            
            <!-- NEW: Actions Dropdown -->
            <div class="actions-dropdown">
                <button class="actions-dropdown-button">Actions ▼</button>
                <div class="actions-dropdown-content">
                    <form action="{{ url_for('trigger_ddns') }}" method="POST">
                        <button type="submit">Check & Update All IPs</button>
                    </form>
                    <form action="{{ url_for('trigger_ssl') }}" method="POST">
                        <button type="submit">Check & Renew All Certs</button>
                    </form>
                    <form action="{{ url_for('trigger_test_notification') }}" method="POST">
                        <button type="submit">Send Test Notification</button>
                    </form>
                </div>
            </div>
            
            <!-- MOVED: Theme toggle button -->
            <button id="theme-toggle" class="theme-button" title="Toggle dark/light mode"></button>
            
        </div>
    </div>

    <table class="domain-table">
        <thead>
            <tr>
                <th style="width: 80%;">Domain Name</th>
                <th>DDNS Status</th>
                <th>SSL Expiration</th>
                <th>Logs</th>
            </tr>
        </thead>
        <tbody>
            {% if domain_configs %}
                {% for domain_config in domain_configs %}
                    <!-- Setup helper variables -->
                    {% set domain_name = domain_config.name %}
                    {% set state = app_state.domain_states.get(domain_name, {}) %}
                    {% set ddns_enabled = domain_config.get('ddns', false) %}
                    {% set ssl_enabled = domain_config.get('ssl', {}).get('enabled', false) %}
                    <!-- NEW: Get per-domain flags -->
                    {% set notifications_enabled = domain_config.get('notifications', true) %}
                    {% set auto_update_enabled = domain_config.get('auto_update', true) %}
                    
                    <tr class="domain-row" data-target="#details-{{ loop.index }}">
                        <td><strong>{{ domain_name }}</strong></td>
                        
                        <!-- DDNS Status Column -->
                        <td>
                            {% if ddns_enabled %}
                                {% set public_ip = app_state.public_ip %}
                                {% set recorded_ip = state.get('recorded_ip') %}
                                
                                {% if recorded_ip and recorded_ip.startswith('ALIAS:') %}
                                    <span class="status-indicator status-unknown">ALIAS</span>
                                {% elif public_ip and recorded_ip %}
                                    {% if public_ip == recorded_ip %}
                                        <span class="status-indicator status-matched">Matched</span>
                                    {% else %}
                                        <span class="status-indicator status-mismatch">Mismatch</span>
                                    {% endif %}
                                {% elif not public_ip %}
                                    <span class="status-indicator status-error">IP Error</span>
                                {% else %}
                                    <span class="status-indicator status-unknown">Unknown</span>
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        
                        <!-- SSL Expiration Column -->
                        <td>
                            {% if ssl_enabled and state.get('ssl_expiration') %}
                                {{ state.ssl_expiration.strftime('%Y-%m-%d') }}
                            {% elif ssl_enabled %}
                                <span class="status-indicator status-mismatch">Missing</span>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        
                        <!-- Log Button Column -->
                        <td>
                            <a href="{{ url_for('view_log', domain_name=domain_name) }}" target="_blank" class="btn btn-secondary btn-sm">View</a>
                        </td>
                    </tr>
                    
                    <!-- Expandable Row -->
                    <tr class="expandable-content" id="details-{{ loop.index }}">
                        <td colspan="4">
                            <div class="details-grid">
                                <div><strong>Current Public IP:</strong> {{ app_state.public_ip or 'N/A' }}</div>
                                <div><strong>Recorded IP (Route 53):</strong> 
                                    {{ state.get('recorded_ip') or 'N/A' }}
                                    <!-- NEW: Refresh Icon -->
                                    <a href="{{ url_for('trigger_refresh_ip', domain_name=domain_name) }}" class="refresh-icon" title="Refresh Recorded IP">⟳</a>
                                </div>
                                <div><strong>DDNS Last Update:</strong> {{ state.get('last_update_time').strftime('%Y-%m-%d %H:%M:%S %Z') if state.get('last_update_time') else 'N/A' }}</div>
                                <div><strong>SSL Last Renew:</strong> {{ state.get('ssl_last_renew').strftime('%Y-%m-%d %H:%M:%S %Z') if state.get('ssl_last_renew') else 'N/A' }}</div>
                                <!-- NEW: Show notification status -->
                                <div><strong>Notifications:</strong> 
                                    {% if notifications_enabled %}
                                        <span style="color: var(--status-matched-bg);">Enabled</span>
                                    {% else %}
                                        <span style="color: var(--status-error-bg);">Disabled</span>
                                    {% endif %}
                                </div>
                                <!-- NEW: Show auto-update status -->
                                <div><strong>Auto-Update:</strong> 
                                    {% if auto_update_enabled %}
                                        <span style="color: var(--status-matched-bg);">Enabled</span>
                                    {% else %}
                                        <span style="color: var(--status-error-bg);">Disabled</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="action-buttons">
                                
                                {% if ddns_enabled %}
                                <!-- UPDATED: Point to new force_update route -->
                                <form action="{{ url_for('trigger_force_update_ip', domain_name=domain_name) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-secondary">Update IP Manually</button>
                                </form>
                                {% endif %}
                                
                                {% if ssl_enabled %}
                                    {% if state.get('ssl_expiration') %}
                                        <form action="{{ url_for('trigger_ssl') }}" method="POST" style="display: inline;">
                                            <button type="submit" class="btn btn-secondary">Renew Cert Manually</button>
                                        </form>
                                    {% else %}
                                        <form action="{{ url_for('trigger_create_cert', domain_name=domain_name) }}" 
                                              method="POST" 
                                              style="display: inline;"
                                              onsubmit="showLoadingOverlay()">
                                            <button type="submit" class="btn btn-primary">Create Cert Manually</button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4" style="text-align: center; padding: 30px;">
                        No domains are configured in /config/config.yml
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- UPDATED: Script now handles the rotating icon -->
    <script>
        function showLoadingOverlay() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
    
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('.domain-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    // Don't toggle row if clicking a link or button
                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('.btn')) {
                        return;
                    }
                    
                    const targetId = row.getAttribute('data-target');
                    const targetRow = document.querySelector(targetId);
                    
                    if (targetRow) {
                        if (targetRow.style.display === 'table-row') {
                            // Collapse
                            targetRow.style.display = 'none';
                            row.classList.remove('is-open');
                        } else {
                            // Expand
                            targetRow.style.display = 'table-row';
                            row.classList.add('is-open');
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}